<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.happyjob.study.tAlert.dao.tNoticeDao">



<!-- 강사 공지사항 리스트 조회+검색 -->
 <select id="searchNotice" resultType="kr.happyjob.study.tAlert.model.tNoticeVO">
 
 		 SELECT 
 		 
 		   n.notice_no 
 		 , n.loginID
 		 , n.notice_title
 		 , DATE_FORMAT(n.notice_created_at, '%y-%m-%d') as notice_created_at
		 , ui.user_type
		 
		FROM tb_notice n
		LEFT JOIN tb_userinfo ui ON n.loginID = ui.loginID
		
		<where>
			<if test="(stitle != null) and (!stitle.equals(''))">
				and n.notice_title like concat('%',#{stitle},'%')
			</if>
			<if test="user_type != null and user_type != ''">
			      AND ui.user_type = #{user_type}
			</if> 
		</where>
		ORDER BY notice_no DESC
		LIMIT #{startpoint}, #{pageSize}
	</select>
	
	<!-- 그룹코드 목록 총 갯수 조회 -->
	<select id="totalcntNotice" resultType="int">
		
		
      select count(*)
       from tb_notice n
              inner join tb_userinfo ui on ui.loginID = n.loginID
              <where>
                <if test="(stitle != null) and (!stitle.equals(''))">
                     and n.notice_title like concat('%',#{stitle},'%')
                </if>
              
              </where>
	</select>
	
	
	
	<!-- 강사 공지사항 셀렉트 -->
	 <select id="selectNotice" resultType="kr.happyjob.study.tAlert.model.tNoticeVO">
	 SELECT
		 n.notice_no
		,n.notice_title
		, DATE_FORMAT(n.notice_created_at, '%y-%m-%d') as notice_created_at
		, n.loginID
		, n.notice_content
		, f.file_no
		, f.file_server_path
		, f.file_local_path
		, f.file_origin
		, f.file_rename
		, f.file_extension
		, f.file_size
		
		FROM tb_notice n
		   left join tb_file f on n.file_no = f.file_no 
		   <!--  inner join tb_userinfo ui on ui.loginID = n.loginID-->
		WHERE n.notice_no = #{notice_no}
	</select>
	
	 <insert id="insertNotice">
	    <selectKey keyProperty="selnotice" resultType="int" order="BEFORE"> 
	   	     SELECT IFNULL(MAX(reply_no),0) +1 FROM tb_notice             
	    </selectKey>
	    
	    INSERT INTO tb_notice
		(
			  notice_title
			, notice_content
			, loginID
			, notice_created_at
			<if test="fileExits eq 'Y'.toString()">
				, file_no
			</if>
			
			)
			VALUES (
			  #{notice_title}
			, #{notice_content}
			, #{loginID}
			, now()
		<if test="fileExits eq 'Y'.toString()">
			, #{file_no}
		</if>
		)
	</insert>
	       
	       <!--   INSERT INTO tb_notice
    (
        notice_title,
        notice_content,
        loginID,
        notice_created_at,
        <choose>
            <when test="isFileAttached eq 'Y'.toString()">
                file_no
            </when>
            <otherwise>
                NULL
            </otherwise>
        </choose>
    )
    VALUES
    (
        #{notice_title},
        #{notice_content},
        #{loginID},
        now(),
        <choose>
            <when test="isFileAttached eq 'Y'.toString()">
                #{file_no}
            </when>
            <otherwise>
                NULL
            </otherwise>
        </choose>
    ) -->
	       
	<delete id="deleteNotice">
		DELETE FROM tb_notice
		WHERE notice_no = #{notice_no}	
	</delete>
	       
	<update id="updateNotice">
		UPDATE tb_notice
		 SET 
		   loginID = #{loginID}
		 , notice_title = #{notice_title}
		 
		 
		 WHERE notice_no = #{notice_no}
		 
		 
	</update>
	
	
	 <insert id="saveFile">
	     <selectKey keyProperty="saventfile" resultType="int" order="BEFORE"> 
	   	     SELECT IFNULL(MAX(ntc_no),0) +1  FROM tb_notice
	    </selectKey>
	       
	       
		INSERT INTO tb_file
		(
		  file_origin
		, file_local_path
		, file_server_path
		, file_size
		, file_extension
		)
		VALUES
		(
		#{file_origin}
		, #{file_local_path}
		, #{file_server_path}
		, #{file_size}
		, #{file_extension}
		)
	</insert>
	
	
</mapper>